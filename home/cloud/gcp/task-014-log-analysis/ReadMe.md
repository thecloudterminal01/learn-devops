# Log Analysis

[https://www.cloudskillsboost.google](https://www.cloudskillsboost.google)

[Select - DevOps Engineer, SRE Learning Path](https://www.cloudskillsboost.google/paths)

## High Level Objectives

- Set up and deploy a test application.
- Explore the log entries generated by the test application.
- Create and use a logs-based metric.
- Export application logs to BigQuery.

### Set up and deploy a test application.

- Enable APIs

```bash
gcloud services enable cloudbuild.googleapis.com \
run.googleapis.com \
compute.googleapis.com \
cloudprofiler.googleapis.com
```


- Clone

```bash
git clone https://github.com/haggman/HelloLoggingNodeJS.git
```

- Change error rate

```node
//Generates an uncaught exception every 20 requests
app.get('/random-error', (req, res) => {
  error_rate = parseInt(req.query.error_rate) || 20
  let errorNum = (Math.floor(Math.random() * error_rate) + 1);
  if (errorNum==1) {
    console.log("Called /random-error, and it's about to error");
    doesNotExist();
  }
 console.log("Called /random-error, and it worked");
 res.send("Worked this time.");
});
```

- Build and deploy

```bash
sh rebuildService.sh

# Set URL ENV
URL=$(gcloud run services list --platform managed --format="value(URL)" | grep hello-logging)

echo $URL

# Add some traffic
while true; \
do curl -s $URL/random-error \
-w '\n' ;sleep .1s;done
```


### Explore the log files for a test application

- Cloud Run Revision > hello-logging


### Create and use a logs-based metric

- Modify while loop to hit different endpoint

```bash
while true; \
do curl -s $URL/score \
-w '\n' ;sleep .1s;done
```

- Explore the logs generated
  - Cloud Run Revision > hello-logging

- Change the `/score` route with below code.
  - Notice how the message contents are now properties of the output object, and how the printed message is the JSON object stringified.

```node
//Basic NodeJS app built with the express server
app.get('/score', (req, res) => {
  //Random score, the contaierID is a UUID unique to each
  //runtime container (testing was done in Cloud Run).
  //funFactor is a random number 1-100
  let score = Math.floor(Math.random() * 100) + 1;
    let output = {
      message:  '/score called',
      score:    score,
      containerID: containerID,
      funFactor: funFactor
  };
  console.log(JSON.stringify(output));
  //Basic message back to browser
  res.send(`Your score is a ${score}. Happy?`);
});
```

- Rebuild and deploy

```bash
sh rebuildService.sh
```

- Restart the loop

```bash
while true; \
do curl -s $URL/score \
-w '\n' ;sleep .1s;done
```

- Explore logs again and examine the new format.
- Create a score logs-based metric using field `jsonPayload.score`
- Create Dashboard using this metric


### Export application logs to BigQuery

- Modify while loop again

```bash
while true; \
do curl -s $URL/random-error \
-w '\n' ;sleep .1s;done
```

- Explore logs again and validate the change
- Create and execute a query to pull just the textPayloads that start with ReferenceError

```roomsql
SELECT
  textPayload
FROM
  `[project-id].hello_logging_logs.run_googleapis_com_stderr_[date]`
WHERE
  textPayload LIKE 'ReferenceError%'
```

- To do a count, modify the query to count these entries:
```roomsql
SELECT
  count(textPayload)
FROM
  `[project-id].hello_logging_logs.run_googleapis_com_stderr_[date]`
WHERE
  textPayload LIKE 'ReferenceError%'
```

- To check the error percentage, build a query that compares the total requests to the ReferenceError% requests.

```roomsql
SELECT
  errors / total_requests
FROM (
  SELECT
    (
    SELECT
      COUNT(*)
    FROM
      `[project-id].hello_logging_logs.run_googleapis_com_requests_[date]`) AS total_requests,
    (
    SELECT
      COUNT(textPayload)
    FROM
      `[project-id].hello_logging_logs.run_googleapis_com_stderr_[date]`
    WHERE
      textPayload LIKE 'ReferenceError%') AS errors)
```